
# Lunar Outpost Optimizer
## Claude Code 実装指示書【完全版 v2】

本ドキュメントは、**数理最適化（拠点配置問題）を月面ゲームとして体験的に学習させる**ための、
Claude Code 向け **完全実装指示書**である。

本書の目的は「設計意図を一切解釈させず、そのまま実装できる状態」を作ることにある。

---

# 0. このドキュメントの位置づけ

- 対象：Claude Code（自律的に設計判断をしない前提）
- ゴール：
  - UI / UX / 操作感 / 数理制約が **破綻なく一体化**したゲームを生成
  - 数理最適化を「感じる」体験を実装

---

# 1. ゲームの根本コンセプト

## 1.1 学習目標

プレイヤーが以下を体験的に理解すること：

- 拠点配置は「場所選び」ではなく「制約の折り合い」である
- 1点の変更が全体解を歪める
- 理論最適解と現実的解は異なる

## 1.2 絶対に守る設計原則

1. 正解をUIで示さない
2. 制約は **禁止ではなく不安定さ** で表現
3. 数値は基本的に隠す
4. 失敗しても即ゲームオーバーにしない

---

# 2. リアリスティックさを担保する設計軸

## 2.1 月面固有制約（必須実装）

| 制約 | UI表現 | 内部評価 |
|---|---|---|
| 日照 | ヒートマップ / 影移動 | 発電量関数 |
| 昼夜 | 時間スライダー | 時系列制約 |
| 地形 | 歪み・赤み | 建設コスト |
| 資源 | 期待値色 | 採掘効率 |
| 通信 | 線の安定度 | 接続制約 |
| 輸送 | 線の太さ | フローコスト |

---

# 3. ゲーム性を生むメカニクス

## 3.1 不完全情報モデル

- 資源量・地形評価には誤差を含む
- 探査拠点により分散が縮小

## 3.2 時間進行

- 1ターン = 月面1日
- 昼夜は14日周期
- 夜間は発電制約が厳化

## 3.3 多目的スコア

内部的には以下を保持する：

- costScore
- survivalScore
- scienceScore
- stabilityScore

UIでは **統合評価バーのみ表示**

---

# 4. 数理最適化モデル（UI翻訳前提）

## 4.1 内部モデル構造（非公開）

- Decision Variables
  - x_i ∈ {0,1}（拠点配置）
  - f_ij ≥ 0（フロー）

- Constraints
  - 電力収支
  - 通信連結性
  - 建設可能性
  - フロー容量

- Objective
  - Weighted sum

※ UIには一切露出させない

---

# 5. UI / UX グローバル設計

## 5.1 画面一覧

1. タイトル
2. ミッション選択
3. メインプレイ
4. What-if比較
5. リザルト

---

# 6. 画面別ワイヤーフレーム（詳細）

## 6.1 メインプレイ画面（最重要）

```
+--------------------------------------------------+
| Budget | Day | Eval | Power | Comm | Crew        |
+-------------+------------------------------------+
| 拠点パレット | 月面マップ                         |
|             |  - 地形                            |
|             |  - 日照                            |
|             |  - 通信                            |
+-------------+------------------------------------+
| 選択拠点状態パネル                               |
+--------------------------------------------------+
```

### UI意図
- 中央マップ以外は視界の端に追いやる
- 視線の80%以上をマップに集中させる

---

# 7. 操作感（ドラッグ・アニメーション）完全仕様

## 7.1 状態定義

- confirmed：確定配置
- provisional：仮配置（ドラッグ中）

## 7.2 dragStart

- 状態：confirmed → provisional
- 表現：
  - 拠点浮上
  - 影分離
- 内部処理：
  - 簡易制約評価モードON

## 7.3 dragMove（毎フレーム）

評価対象（軽量）：

- 建設可否
- 日照期待値
- 通信接続可能性

UI更新：

- 地面歪み
- 接続線遅延
- 他拠点揺れ

## 7.4 drop

- 完全制約評価
- 結果に応じた状態遷移：
  - 安定
  - 不安定（警告保持）
  - 破綻（遅延トラブル）

---

# 8. 制約と視覚表現の完全対応表

| 視覚 | 意味 | 評価頻度 |
|---|---|---|
| 地面歪み | コスト増 | drag |
| 線点滅 | 通信違反 | drop |
| 拠点揺れ | 感度大 | drag |
| 暗転 | 電力不足 | 夜間 |
| ノイズ | 冗長性欠如 | 常時 |

---

# 9. What-if / Undo 仕様

## 9.1 Undo

- 逆再生アニメーション
- 状態完全復元

## 9.2 比較

- 案A/B同時保持
- 差分のみ強調表示

---

# 10. リザルト画面

- プレイヤー解 vs 理論解
- 差分ヒートマップ表示
- 解説は **後出し**

---

# 11. MVPスコープ（必須）

- 拠点5種
- 制約4種
- ミッション1つ
- ソルバ連携なし

---

# 12. 実装上の最重要注意

Claude Codeは以下を**絶対にしないこと**：

- 最適解をリアルタイム表示
- 数式をUI表示
- 数値中心UI

---

# 13. 最終メッセージ

このゲームの成功条件はただ一つ：

**「プレイヤーが、なぜその配置が苦しいのかを“感じて”理解すること」**

Claude Codeは本ドキュメントを唯一の正とし、
一切の独自解釈を加えず実装せよ。
